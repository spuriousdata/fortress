#!/bin/sh

#set -x

FTPHOST=http://ftp.freebsd.org/pub/FreeBSD/releases/$(uname -m)
#SETS="base.txz lib32.txz ports.txz src.txz"
SETS="base.txz lib32.txz src.txz"
EUID=$(id -u)

PV=$(which pv)
if [ $? -ne 0 ]; then
	PV=""
fi

CONFIG=/usr/local/etc/fortress.conf

if [ "x$1" = "x-f" ]; then
	CONFIG=$2
	shift; shift
fi
	

if [ -f $CONFIG ]; then
	. $CONFIG
else
	stderr "No configuration found. Copy $CONFIG.sample to $CONFIG and edit it before running fortress"
	exit 1
fi


usage()
{
	stderr $0 "[setup|create|destroy|list|start|stop|restart|startall|stopall|update|etcupdate|console]"
}

stderr()
{
	echo $@ >&2
}

warn()
{
	if [ ${NOWARN:-0} -ne 1 ]; then
		stderr $1
	fi
}

mp()
{
	zfs get -H mountpoint $1 2>/dev/null | awk '{print $3}'
}

checkrc()
{
	rc=-1
	eval "$*;rc=$?"
	if [ $rc -ne 0 ]; then
		stderr Error running $*
		exit $rc
	fi
}

setup()
{
	needsroot

	zfs list $DATASET > /dev/null 2>&1
	if [ $? -ne 0 ]; then
		echo -n "fortress dataset '$DATASET' does not exist. Should I create it? [y/N]: "
		read RESPONSE
		case $RESPONSE in
			[Yy]|[Yy][Ee][Ss])
				stderr Creating $DATASET
				checkrc zfs create -po mountpoint=/fortress $DATASET
				;;
			*)
				exit
				;;
		esac
	fi


	FS="jails sets/$RELEASE release/$RELEASE/root"
	
	for F in $FS
	do
		zfs list $DATASET/$F > /dev/null 2>&1
		if [ $? -ne 0 ]; then 
			stderr Creating $DATASET/$F
			checkrc zfs create -p $DATASET/$F
		fi
	done

	MP=$(mp $DATASET/sets/$RELEASE)
	RMP=$(mp $DATASET/release/$RELEASE)
	for SET in $SETS
	do
		if [ ! -f $MP/$SET ]; then
			stderr Fetching $MP/$SET
			checkrc fetch -o $MP/$SET $FTPHOST/$RELEASE/$SET
		fi
	done
	
	for SET in $SETS
	do
		if [ -f $RMP/.fortress_extracted_$SET ]; then
			continue
		fi

		PROGBAR="cat"
		if [ ! -z ${PV+is_set} ]; then
			PROGBAR="$PV -s $(stat -f %z $MP/$SET)"
		fi

		stderr Extracting $MP/$SET in $RMP/root
		cat $MP/$SET | $PROGBAR | tar -C $RMP/root -xJf-
		
		touch $RMP/.fortress_extracted_$SET
	done
	
	if [ ! -d $RMP/root/etcupdate ]; then
		mkdir $RMP/root/etcupdate
	fi
	
	
	stderr Checking for $RMP/root/etcupdate
	if [ ! -f $RMP/root/etcupdate/etcupdate-$RELEASE.tbz ]; then
		stderr Creating etcupdate-$RELEASE.tbz
		mount -t devfs devfs $RMP/root/dev
		chroot $RMP/root etcupdate build /etcupdate/etcupdate-$RELEASE.tbz
		umount $RMP/root/dev
	fi
	stderr Fortress setup complete
	touch $(mp $DATASET)/.fortress_setup_complete
}

setupcomplete()
{
	MP=$(mp $DATASET)
	if [ -f $MP/.fortress_setup_complete ]; then
		echo 1
	else
		echo 0
	fi
}

mount_jail()
{
	local MP=$1
	
	SMP=$(mp $DATASET/release/$RELEASE/root)
	
	if [ ! -e $MP/var/ports ]; then
		mkdir -p $MP/var/ports
		mkdir -p $MP/var/ports/distfiles
		mkdir -p $MP/var/ports/packages
	fi
	
	if [ ! -e $MP/var/db ]; then
		mkdir $MP/var/db
	fi
	
	if [ ! -e $MP/compat ]; then
		mkdir $MP/compat
	fi
	
	if [ ! -e $MP/usr/obj ]; then
		mkdir -p $MP/usr/obj
	fi
	
	for _d in $MOUNT; do
		mount -t nullfs -o ro $SMP/$_d $MP/$_d
	done
	
	if [ ! -d $MP/dev ]; then
		mkdir $MP/dev
	fi
	mount -t devfs devfs $MP/dev
	
	if [ ! -d $MP/tmp ]; then
		mkdir $MP/tmp
	fi
	mount -t tmpfs tmpfs $MP/tmp
}

umount_jail()
{
	local MP=$1
	
	for _d in $MOUNT; do
		umount $MP/$_d
	done
	umount $MP/dev
	umount $MP/tmp
}

needsroot()
{
	if [ $EUID -ne 0 ]; then
		stderr "Command requires root privileges"
		exit
	fi
}

create()
{
	needsroot

	load_local_overrides $1
	
	local name=${1:?jail name is required}
	
	zfs list $DATASET/jails/$name > /dev/null 2>&1
	if [ $? -eq 0 ]; then
		stderr "Jail $name already exists"
		return
	fi
	
	echo Creating jail dataset
	zfs create $DATASET/jails/$name
	zfs create $DATASET/jails/$name/root
	
	MP=$(mp $DATASET/jails/$name)
	
	echo Creating jail root directories
	for _d in $MOUNT; do
		mkdir -p $MP/root/$_d
	done
	
	RMP=$(mp $DATASET/release/$RELEASE/root)
	echo Copying /etc
	cd $RMP/etc && find . | cpio -dp --quiet $MP/root/etc

	echo Copying /root
	cd $RMP/root && find . | cpio -dp --quiet $MP/root/root

	echo Copying /etc/localtime
	cp /etc/localtime $MP/root/etc

	echo Creating /etc/rc.conf
	cat > $MP/root/etc/rc.conf <<EOF
hostname=$name
cron_flags="-J 15"

$IFCONFIG

# Disable Sendmail by default
sendmail_enable="NONE"
sendmail_submit_enable="NO"
sendmail_outbound_enable="NO"
sendmail_msp_queue_enable="NO"

# Run secure syslog
syslogd_flags="-c -ss"
EOF

	echo Creating /etc/resolv.conf
	if [ ! -z ${RESOLV_CONF+is_set} ]; then
		cat > $MP/root/etc/resolv.conf <<EOF
$RESOLV_CONF
EOF
	fi
	
	echo Extracting etcupdate-$RELEASE.tbz
	mount_jail $MP/root
	chroot $MP/root etcupdate extract -t /etcupdate/etcupdate-$RELEASE.tbz
	umount_jail $MP/root

	echo Writing jail.conf
	cat > $MP/jail.conf <<EOF
$name {
	host.hostname = "\$name.$DOMAIN";
	path = "$MP/root";

	mount.devfs;
	mount.fstab = "$MP/fstab";

	vnet;
	vnet.interface = "e0b_\$name";

	exec.system_user = "root";
	exec.jail_user = "root";
	
	exec.clean;
	exec.start = "/bin/sh /etc/rc";
	exec.stop = "/bin/sh /etc/rc.shutdown";
	exec.consolelog = "/var/log/jail_\${name}_console.log";
	exec.prestart += "$JIB addm \${name} $PUBLIC_IFACE";
	exec.poststop += "$JIB destroy \${name}";
}
EOF

	echo Writing fstab
	SMP=$(mp $DATASET/release/$RELEASE/root)
	(echo "#Device Mountpoint FStype Options Dump Pass"
	 for _d in $MOUNT; do
		echo $SMP/$_d $MP/root/$_d nullfs ro 0 0
	 done) | column -t > $MP/fstab

	 echo Jail created
}

destroy()
{
	needsroot

	local name=${1:?jail name is required}

	jls -j $name >/dev/null 2>&1
	if [ $? -eq 0 ]; then
		stop $name
	fi
	
	MP=$(mp $DATASET/jails/$name)
	
	echo -n "Are you sure you want to destroy $MP? [y/N]: "
	read RESP
	RESP=${RESP:-N}
	if [ $RESP = 'y' -o $RESP = 'Y' ]; then
		zfs destroy $DATASET/jails/$name/root
		zfs destroy $DATASET/jails/$name
	fi
}

ip_from_rc_conf()
{
	local name=${1:?jail name is required}
	local mp=${2:?mountpoint is required}
	IP=$(grep e0b_$name $mp/root/etc/rc.conf | awk 'match($0, /inet [\.0-9]+/){print substr($0, RSTART+5, RLENGTH-5)}')
	echo $IP
}


list()
{
	(echo JID IP NAME MOUNTPOINT RUNNING
	get_jail_names mountpoint | while read -r name mp; do
		JID=$(jls -j $name -qn jid 2>/dev/null | cut -f2 -d=)

		if [ "x$JID" != "x" ]; then
			IP=$(jexec $name ifconfig e0b_$name 2>/dev/null | awk '/inet/{print $2}')
			if [ ! -z ${IP+is_set} ]; then
				warn "Can't connect to jail without root, parsing rc.conf for IP"
				_ip=$(ip_from_rc_conf $name $mp)
				IP=${_ip:=n/a}
			fi
			RUNNING=yes
		else
			_ip=$(ip_from_rc_conf $name $mp)
			IP=${_ip:=n/a}
			RUNNING=no
			JID=n/a
		fi
		echo $JID $IP $name $mp $RUNNING
	done) | column -t
}

needsjib()
{
	if [ ! -x $JIB ]; then
		stderr "fortress requires $JIB to exist and be executable. If jib exists in a different location, set it in $CONFIG"
		exit 1
	fi
}

start()
{
	needsroot
	needsjib

	local name=${1:?jail name is required}

	MP=$(mp $DATASET/jails/$name)
	echo Starting $name...
	jail -qcf $MP/jail.conf
}

stop()
{
	needsroot
	needsjib

	local name=${1:?jail name is required}

	MP=$(mp $DATASET/jails/$name)
	echo Stopping $name...
	jail -qrf $MP/jail.conf $name
}

update()
{
	needsroot

	ZR=$DATASET/release/$RELEASE/root
	R=$(mp $ZR)
	CMD="/usr/sbin/freebsd-update -b $R -d $R/var/db/freebsd-update/ -f $R/etc/freebsd-update.conf --not-running-from-cron"

	zfs list $ZR@pre-update >/dev/null 2>&1
	ret=$?
	if [ $ret -eq 0 ]; then
		stderr "$ZR@pre-update already exists. Delete it first."
		exit $ret
	fi

	zfs snap $ZR@pre-update
	ret=$?
	if [ $ret -ne 0 ]; then
		stderr "Error taking snapshot"
		exit $ret
	fi

	PAGER=cat $CMD fetch 
	$CMD install 
	if [ $? -eq 0 ]; then
		# rebuild etcupdate-$RELEASE.tbz
		mount -t devfs devfs $R/dev
		chroot $R etcupdate build /etcupdate/etcupdate-$RELEASE.tbz
		umount $R/dev
		echo "Updates installed. Restart jails then run 'fortress.sh etcupdate jail1 jail2 ... jailN'"
	else
		echo "No updates to install"
	fi
}

etcupdate()
{
	for jail in $@
	do
		jexec $jail /usr/sbin/etcupdate -F -t /etcupdate/etcupdate-$RELEASE.tbz
	done
	echo "etcupdate complete. Restart jails a final time"
}

load_local_overrides()
{
	local name=${1:?jail name is required}
	
	LCONFIG=/usr/local/etc/fortress/$name.conf
	if [ -f $LCONFIG ]; then
		. $LCONFIG
	else
		stderr Create $LCONFIG.
		stderr It should contain zero or more overrides of variables from $CONFIG.
		exit 1
	fi
}

startall()
{
	get_jail_names mountpoint | while read -r jail mp; do
		if [ -f $mp/NOAUTO ]; then
			stderr "Skipping $jail because $mp/NOAUTO exists"
			continue
		else
			start $jail
		fi
	done
}

get_jail_names()
{
	local args=""
	if [ ! -z ${1+is_set} ]; then
		args=",$1"
	fi
	zfs list -r -d1 -oname$args $DATASET/jails | tail -n+3 | sed "s@$DATASET/jails/@@"
}

stopall()
{
	get_jail_names | while read -r jail; do
		jls -j $jail >/dev/null 2>&1
		if [ $? -eq 0 ]; then
			stop $jail
		else
			echo "$jail not running"
		fi
	done
}

main()
{
	if [ $(setupcomplete) = "1" ]; then
		case $1 in 
			create)
				shift
				create $@
				;;
			destroy)
				shift
				destroy $@
				;;
			list)
				shift
				list $@
				;;
			start)
				shift
				start $@
				;;
			startall)
				shift
				startall $@
				;;
			stopall)
				shift
				stopall $@
				;;
			stop)
				shift
				stop $@
				;;
			restart)
				shift
				stop $@
				start $@
				;;
			update)
				shift
				update $@
				;;
			etcupdate)
				shift
				etcupdate $@
				;;
			console)
				shift
				jexec -l $1 /bin/csh
				;;
			*)
				if [ ! -z $1 ]; then 
					stderr unknown command $1
				fi
				usage
				;;
		esac
	else
		if [ "x$1" = "xsetup" ]; then
			shift
			setup $@
		else
			stderr
			stderr Configure $CONFIG then run \'$0 setup\'
			stderr 
		fi
	fi
}

main $@
